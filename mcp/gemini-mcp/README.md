# gemini-mcp

Gemini CLI を安全に呼び出すための MCP サーバー実装（Go 版）。`main.go` で stdio 上の JSON‑RPC を実装し、MCP クライアント（例: エディタ拡張やエージェント）から安全に Gemini を利用できます。

---

## 概要

- 言語: Go 1.24.6
- 通信: JSON‑RPC over stdio（MCP プロトコル）
- 役割: Gemini CLI への安全なラッパー
  - 非対話実行では `-p`（プロンプト）必須
  - 実行前確認のスキップに `--yolo`（自己責任）
- 提供ツール: `gemini`, `gemini_reply`, `gemini_raw`
- モデル指定: `-m`/`--model` で任意指定可能
- デバッグ: `-d`/`--debug`
- 全ファイル含める: `-a`
- デフォルトタイムアウト: 120000ms

---

## 前提

- Go 1.24.6 がインストール済み
- Gemini CLI が利用可能かつ認証済み（本サーバーは CLI をラップします）
- MCP クライアント（本サーバーをサブプロセスとして起動し、stdio でやり取りできるもの）

---

## ビルド

プロジェクト直下（`gemini-mcp/` ディレクトリ）で以下を実行します。

```bash
cd gemini-mcp
go build -o gemini-mcp
```

生成物: `./gemini-mcp`

---

## 実行

MCP クライアントからサーバーとして起動される想定です（stdio で JSON‑RPC 通信）。手元で単体起動して動作確認する場合は:

```bash
./gemini-mcp --debug
```

- `--debug`: リクエスト/レスポンスの詳細ログを標準エラーに出力します。

MCP クライアント側の設定例（疑似例）:

```json
{
  "mcpServers": {
    "gemini": {
      "command": "/absolute/path/to/gemini-mcp/gemini-mcp",
      "args": ["--debug"]
    }
  }
}
```

---

## ツール

本サーバーは MCP の `tools/list` に以下 3 つのツールを公開します。いずれも Gemini CLI を呼び出しますが、入出力の扱いと整形が異なります。

- gemini: 一般的な生成向けの安全ラッパー
  - 非対話実行では `-p` 必須。標準的な前処理と出力整形を行います。
  - `-a` 指定時はカレントディレクトリ配下のファイルを（サイズ・除外規則に従い）文脈として添付。
- gemini_reply: 返信や短い追記向けの軽量エンドポイント
  - プロンプト主体で素早く返答したいケース向け。共通オプションは利用可能。
- gemini_raw: 生の CLI 呼び出し結果を返す
  - サーバー側での整形を最小限にし、CLI の出力をそのまま返します。高度な制御やデバッグ時に有用。

いずれのツールも、共通して以下のオプションを受け付けます（MCP tool 引数として渡す想定）。

---

## 共通オプション

- `-p, --prompt <TEXT>`: 非対話実行時は必須のプロンプト文字列。
- `-m, --model <MODEL>`: 利用するモデル名を指定（任意）。例: `gemini-2.0-pro` など。
- `-d, --debug`: デバッグログを有効化。
- `-a` (all files): カレントディレクトリ配下の全ファイルを文脈として含める（サイズ上限・除外に注意）。
- `--yolo`: 実行前確認を自動承認（危険、自己責任）。
- `--timeout <ms>`: 実行タイムアウト。デフォルト `120000`（ミリ秒）。

注意:
- 非対話実行（MCP クライアントがプロンプト入力 UI などを用意しないケース）では、`-p` が必須です。
- `--yolo` は安全確認をスキップします。自動変更・書き込みを伴う操作では特に注意してください。

---

## 使い方（MCP 例）

MCP クライアントからの `tools/call` イメージ（疑似 JSON）:

- 通常の生成（gemini）
```json
{
  "name": "gemini",
  "arguments": {
    "prompt": "README を要約してください",
    "model": "gemini-2.0-pro",
    "debug": true,
    "timeout": 120000
  }
}
```

- 返信・追記（gemini_reply）
```json
{
  "name": "gemini_reply",
  "arguments": {
    "prompt": "先ほどの回答に注意点を1つ追記してください",
    "model": "gemini-2.0-flash"
  }
}
```

- 生結果（gemini_raw）
```json
{
  "name": "gemini_raw",
  "arguments": {
    "prompt": "このファイル群のリファクタ方針を提案して",
    "a": true,
    "yolo": false
  }
}
```

MCP クライアントは本サーバーをサブプロセスとして起動し、stdio で JSON‑RPC をやり取りします。サーバーは受け取った引数に応じて Gemini CLI を安全に呼び出し、結果をツール応答として返します。

---

## セキュリティと安全性

- 非対話実行では `-p` 必須: 明示的なプロンプトがない自動実行を禁止し、誤操作を防ぎます。
- 実行前確認: デフォルトでは実行前の確認を行い、危険な操作を抑止します。
- `--yolo` の扱い: すべての確認を自動承認します。CI や一括実行などの用途向けですが、取り扱いは自己責任です。
- `-a` の扱い: 全ファイルを入力文脈に含めます。機密ファイルや大容量ファイルの取り扱いに注意してください。

---

## トラブルシュート

- ビルドに失敗する:
  - Go 1.24.6 の利用を確認してください。
- モデルが見つからない/呼び出せない:
  - Gemini CLI がインストール・認証済みか、`-m/--model` の指定が正しいか確認してください。
- タイムアウトする:
  - `--timeout` を延ばす、あるいはプロンプト/添付ファイルを縮小してください。
- 出力が想定と異なる:
  - `gemini_raw` で生出力を確認し、`gemini`/`gemini_reply` との差を切り分けてください。
  - `--debug` で詳細ログを確認してください。

---

## 開発

- エントリポイント: `main.go`（stdio 上の JSON‑RPC 実装とツール定義）
- ビルド: `go build`
- 依存: 外部ネットワーク・API 呼び出しは Gemini CLI に委譲（本サーバーはラッパー）

プロジェクトに合わせて必要に応じてツールやオプションを拡張してください。
