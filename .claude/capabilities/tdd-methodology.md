# TDD 実践方法論（t-wada エッセンス）

> **目的**: Claude が高品質なコードとテストを生成できるように、厳密で反復可能な TDD ループを適用する。トリッキーなことはせず、小さく、観測可能で、巻き戻し可能なステップを守る。

## 適用場面

- 新しい振る舞いの追加やバグ修正が必要なとき
- 振る舞いを具体例で説明できるとき
- ローカルでテストが実行できるとき

## 基本ループ（Canon TDD）

1. **テストリストを作る**

   - 期待される振る舞い（例）を短くチェックリスト化する。各項目は独立してテスト可能にする。

2. **1 つ選んで失敗するテストを書く（RED）**

   - 振る舞いに向けた最小の一歩。
   - テストは正しい理由で失敗する必要がある。

3. **テストを通す（GREEN）**

   - 本番コードを最小限変更して、**すべて**のテストを通す。
   - 「良い設計」よりも最小の動く変更を優先する。

4. **リファクタリング（REFACTOR）**

   - 可読性を上げ、重複を排除し、意図を明確にする。
   - 振る舞いは変えない。テストはすべてグリーンのまま。

5. **繰り返す**

   - テストリストが空になるまで 2 から繰り返す。

## 実装段階

- **仮実装（Fake it）**: 定数やスタブで現在のテストだけを満たす。
- **三角測量（Triangulation）**: さらに例を追加して一般化を強制する。
- **明白な実装（Obvious implementation）**: 一般化が明確になったら本当のロジックを実装する。

## ガードレール（必ず守るルール）

- **テストファーストのみ**: 失敗するテストなしに本番コードを書かない。
- **一歩ずつ**: 1 テスト → 最小のコード変更 → リファクタ。
- **インターフェイスと実装の分離**: API/形はテストで決め、内部は隠す。
- **テストはシンプルに**: テストにロジックを含めず、単純なデータと明快なアサーションを使う。
- **小さな差分**: 各コミットはレビューしやすく、巻き戻しやすくする。

## ヒューリスティック（判断の助け）

- 一般解に確信がない → **例を追加**（三角測量）。
- 2 つのテストが重複 → グリーン後に**リファクタ**。
- リファクタでテストが壊れた → ロールバック（振る舞いが変わった）。
- テストが書きにくい → API を見直す（設計が密結合かも）。
- まず**外部からの振る舞いテスト**を書く。必要に応じて内部へ掘る。

## サイクルごとの完了定義

- 新しいテストがレッドで始まり、グリーンで終わる。
- すべてのテストがローカルでパス。
- 明らかな重複が除去され、名前が意図を明確にしている。
- テストリストが更新される（チェック済みか調整済み）。

## アンチパターン

- 複数の失敗テストを書いてからまとめてグリーンにする。
- レッド中やテストなしでの大規模リファクタ。
- 内部実装に依存した過剰な指定（脆いテスト）。
- テスト内にロジックを埋め込む（分岐やループ）。
- 「仮実装」段階を飛ばして壮大な設計に飛びつく。

## 最小例（`RomanNumerals.toRoman(n)` を駆動）

**テストリスト（開始時）**

- 1 → "I"
- 2 → "II"
- 3 → "III"
- 4 → "IV"
- 5 → "V"

**サイクル 1**

- RED: `toRoman(1) == "I"`（失敗）
- GREEN（仮実装）: 無条件で "I" を返す
- REFACTOR: なし

**サイクル 2（三角測量）**

- RED: `toRoman(2) == "II"`（失敗）
- GREEN: 2 を処理する最小変更（小さい n では 'I' を繰り返すなど）
- REFACTOR: マッピング抽出、重複除去

**サイクル 3**

- RED: `toRoman(4) == "IV"`
- GREEN: 減算表記に対応する最小の拡張
- REFACTOR: アルゴリズム整理、全テストグリーン

各グリーン後に**テストリストを更新**。

## テスト作成チェックリスト

- [ ] 名前が振る舞いを説明している（メソッド名ではない）。
- [ ] Arrange–Act–Assert が明示されている。
- [ ] 実装前に正しい理由で失敗する。
- [ ] 単一の振る舞いを検証（または同一概念に関するアサート群）。
- [ ] 外部境界を越える場合以外はモックしない。

## リファクタリングチェックリスト

- [ ] 重複除去（三度目の繰り返しで実行）。
- [ ] 名前の改善、単純な間接はインライン化。
- [ ] 関数は小さく純粋に（可能な限り）。
- [ ] 副作用は端に押し出す。
- [ ] すべてのテストがグリーンのまま。

## Claude Code 用プロンプト例

- **サイクル開始**

  - 「<機能> の _テストリスト_ を具体例の箇条書きで作ってください。項目は原子的に。」

- **最初のテストを書く**

  - 「テストリストから 1 つ選び、<言語>/<テストフレームワーク> で単一の失敗テストを実装してください。なぜ失敗するか説明も。」

- **テストを通す**

  - 「すべてのテストを通す _最小限_ の本番コードを適用してください。差分のみ表示。」

- **リファクタリング**

  - 「振る舞いを変えずに重複除去と意図の明確化をしてください。差分と理由を表示。」

- **三角測量**

  - 「一般化を強制する例を 1 つ追加し、最小限の修正で対応してください。」

## 品質基準

- 小さくレビュー可能な差分と明確なコミットメッセージ: `test: describe behavior`, `feat: minimal pass`, `refactor: remove duplication`
- ドキュメントのように読めるテスト。奇をてらわない。
- 三角測量後に明らかに正しいコード。

## マルチエージェントワークフローでの役割

- **Planner**: テストリストと受け入れ基準を作成。
- **Spec-writer**: 例をドメイン用語に合わせる。
- **Architect**: API 境界を安定化。まず境界テストを作成。
- **Implementer**: Red–Green–Refactor ループを駆動。
- **Reviewer**: アンチパターン検出とチェックリスト検証。

---

このファイルは Canon TDD の t-wada 解釈を反映：テストリストから始め、小さなステップ（Red→Green→Refactor）、仮実装 → 三角測量 → 明白な実装を進め、インターフェイスと実装を分離する。
